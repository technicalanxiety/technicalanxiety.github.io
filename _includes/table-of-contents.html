<div class="table-of-contents">
  <div class="toc-header">
    <h3 class="toc-title">
      <ion-icon name="list-outline"></ion-icon>
      Table of Contents
    </h3>
    <button class="toc-toggle" aria-label="Toggle table of contents">
      <ion-icon name="chevron-up-outline" class="toc-toggle-icon"></ion-icon>
    </button>
  </div>
  <nav class="toc-nav" id="toc-nav">
    <!-- TOC will be generated by JavaScript -->
  </nav>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const tocNav = document.getElementById('toc-nav');
    const postBody = document.querySelector('.post-body, .page-body');
    
    if (!tocNav || !postBody) return;
    
    // Find all headings in the post
    const headings = postBody.querySelectorAll('h2, h3');
    
    if (headings.length === 0) {
      // Hide TOC if no headings
      document.querySelector('.table-of-contents').style.display = 'none';
      return;
    }
    
    // Generate TOC
    const tocList = document.createElement('ol');
    tocList.className = 'toc-list';
    
    headings.forEach((heading, index) => {
      // Add ID to heading if it doesn't have one
      if (!heading.id) {
        heading.id = 'heading-' + index;
      }
      
      const listItem = document.createElement('li');
      listItem.className = 'toc-item toc-' + heading.tagName.toLowerCase();
      
      const link = document.createElement('a');
      link.href = '#' + heading.id;
      link.textContent = heading.textContent;
      link.className = 'toc-link';
      
      listItem.appendChild(link);
      tocList.appendChild(listItem);
    });
    
    tocNav.appendChild(tocList);
    
    // Smooth scroll to section
    const tocLinks = tocNav.querySelectorAll('.toc-link');
    tocLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const targetId = this.getAttribute('href').substring(1);
        const targetElement = document.getElementById(targetId);
        
        if (targetElement) {
          const offset = 80; // Account for fixed header
          const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - offset;
          
          window.scrollTo({
            top: targetPosition,
            behavior: 'smooth'
          });
        }
      });
    });
    
    // Highlight active section on scroll
    function highlightActiveSection() {
      let current = '';
      
      headings.forEach(heading => {
        const sectionTop = heading.offsetTop - 100;
        if (window.pageYOffset >= sectionTop) {
          current = heading.id;
        }
      });
      
      tocLinks.forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('href') === '#' + current) {
          link.classList.add('active');
        }
      });
    }
    
    window.addEventListener('scroll', highlightActiveSection);
    highlightActiveSection(); // Initial call
    
    // Toggle TOC on mobile
    const tocToggle = document.querySelector('.toc-toggle');
    const toc = document.querySelector('.table-of-contents');
    
    if (tocToggle) {
      tocToggle.addEventListener('click', function() {
        toc.classList.toggle('collapsed');
      });
    }
  });
</script>
