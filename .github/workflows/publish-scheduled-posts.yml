name: Publish Scheduled Posts

# Runs daily at 9 AM UTC (adjust timezone as needed)
# Also allows manual triggering from Actions tab
on:
  schedule:
    - cron: '0 9 * * *'  # Daily at 9 AM UTC
  workflow_dispatch:  # Allows manual trigger

jobs:
  publish-posts:
    runs-on: ubuntu-latest
    
    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # Set up Git configuration for commits
      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
      # Run Python script to move posts from backlog and update series links
      - name: Publish scheduled posts and update series links
        run: |
          python3 << 'EOF'
          import os
          import re
          from datetime import datetime, timezone
          from pathlib import Path
          
          # Define paths
          backlog_dir = Path('_posts/backlog')
          posts_dir = Path('_posts')
          
          # Get current date in UTC
          today = datetime.now(timezone.utc).date()
          
          # Track published posts and updated links
          published_posts = []
          updated_links = []
          
          # Check if backlog directory exists
          if not backlog_dir.exists():
              print("No backlog directory found")
              exit(0)
          
          # Iterate through all markdown files in backlog
          for post_file in backlog_dir.glob('*.md'):
              # Read the file content
              content = post_file.read_text(encoding='utf-8')
              
              # Extract the date from front matter
              # Looking for: date: 2024-11-25 or date: 2024-11-25 12:00:00
              date_match = re.search(r'^date:\s*(\d{4}-\d{2}-\d{2})', content, re.MULTILINE)
              
              if date_match:
                  post_date_str = date_match.group(1)
                  post_date = datetime.strptime(post_date_str, '%Y-%m-%d').date()
                  
                  # Check if post date is today or earlier
                  if post_date <= today:
                      # Move the post to main posts directory
                      destination = posts_dir / post_file.name
                      post_file.rename(destination)
                      published_posts.append(post_file.name)
                      print(f"Published: {post_file.name} (dated {post_date_str})")
                      
                      # Extract slug from filename (remove date prefix and .md extension)
                      slug_match = re.search(r'\d{4}-\d{2}-\d{2}-(.*?)\.md', post_file.name)
                      if slug_match:
                          slug = slug_match.group(1)
                          
                          # Extract title from the newly published post
                          title_match = re.search(r'^title:\s*["\']?(.+?)["\']?\s*$', content, re.MULTILINE)
                          title = title_match.group(1) if title_match else "Next Part"
                          
                          # Now scan all published posts for placeholders referencing this post
                          for existing_post in posts_dir.glob('*.md'):
                              if existing_post.name == post_file.name:
                                  continue  # Skip the newly published post itself
                              
                              existing_content = existing_post.read_text(encoding='utf-8')
                              
                              # Look for placeholder pattern: <!-- NEXT_PART: filename -->...<!-- END_NEXT_PART -->
                              placeholder_pattern = f'<!-- NEXT_PART: {post_file.name} -->.*?<!-- END_NEXT_PART -->'
                              
                              if re.search(placeholder_pattern, existing_content, re.DOTALL):
                                  # Replace placeholder with actual link
                                  new_content = re.sub(
                                      placeholder_pattern,
                                      f'**Next in Series:** [{title} →](/{slug}/)',
                                      existing_content,
                                      flags=re.DOTALL
                                  )
                                  
                                  # Write back the updated content
                                  existing_post.write_text(new_content, encoding='utf-8')
                                  updated_links.append(existing_post.name)
                                  print(f"Updated series link in: {existing_post.name}")
          
          # Output summary
          if published_posts:
              print(f"\n✓ Published {len(published_posts)} post(s)")
              if updated_links:
                  print(f"✓ Updated series links in {len(updated_links)} post(s)")
              exit(0)
          else:
              print("No posts ready to publish")
              exit(0)
          EOF
          
      # Commit and push if there are changes
      - name: Commit and push changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            git add _posts/
            git commit -m "Auto-publish scheduled posts [skip ci]"
            git push
            echo "✓ Changes committed and pushed"
          else
            echo "No changes to commit"
          fi
